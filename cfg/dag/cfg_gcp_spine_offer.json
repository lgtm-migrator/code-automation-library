{
  "name": "GCP_SPINE_OFFER",
  "dag": {
    "description": "Populates portfolio offer tables uk_pub_customer_spine_offer_is",
    "tags": ["offer", "customer"]
  },
  "args": {
    "owner": "customerbtprod",
    "email": ["sean.conkie@sky.uk"]
  },
  "properties": {
    "dataset_source": "uk_arc_chordiant_is",
    "dataset_staging": "uk_pre_customer_spine_offer_is",
    "dataset_publish": "uk_pub_customer_spine_offer_is",
    "gs_source_bucket": "uk_customer_tds_is"
  },
  "imports": [],
  "tasks": [{
      "task_id": "load_teams",
      "operator": "LoadFromGCS",
      "parameters": {
        "source_objects": ["team*.json"],
        "schema_object": "cfg/table/arc_team.json",
        "destination_table": "arc_teams"
      },
      "dependencies": []
    },
    {
      "task_id": "dim_offer_type",
      "operator": "CreateTable",
      "parameters": {
        "destination_table": "dim_offer_type",
        "target_type": 1,
        "driving_table": "uk_tds_refdata_eod_is.cc_refdata_bsboffertooffertype",
        "joins": [{
          "right": "uk_tds_refdata_eod_is.cc_refdata_bsboffertype",
          "on": [{
              "operator": "=",
              "fields": ["uk_tds_refdata_eod_is.cc_refdata_bsboffertooffertype.offertypeid", "uk_tds_refdata_eod_is.cc_refdata_bsboffertype.id"]
            },
            {
              "operator": "<>",
              "fields": ["uk_tds_refdata_eod_is.cc_refdata_bsboffertype.rdmaction", "'D'"]
            }
          ]
        }],
        "source_to_target": [{
            "name": "id",
            "source_column": "id",
            "pk": true
          },
          {
            "name": "dw_last_modified_dt",
            "transformation": "current_timestamp()"
          },
          {
            "name": "offer_detail_id",
            "source_column": "offerid"
          },
          {
            "name": "offer_type_id",
            "source_column": "offertypeid"
          },
          {
            "name": "offer_type_id",
            "source_column": "offertypeid"
          },
          {
            "name": "created_dt",
            "source_column": "created"
          },
          {
            "name": "created_by_id",
            "source_column": "createdby"
          },
          {
            "name": "last_modified_dt",
            "source_column": "lastupdate"
          },
          {
            "name": "last_modified_by_id",
            "source_column": "updatedby"
          },
          {
            "name": "code",
            "source_name": "uk_tds_refdata_eod_is.cc_refdata_bsboffertype",
            "source_column": "code"
          },
          {
            "name": "description",
            "source_name": "uk_tds_refdata_eod_is.cc_refdata_bsboffertype",
            "source_column": "description"
          }
        ],
        "where": [{
          "operator": "<>",
          "fields": ["uk_tds_refdata_eod_is.cc_refdata_bsboffertooffertype.rdmaction", "'D'"]
        }]
      },
      "dependencies": []
    },
    {
      "task_id": "td_offer_status_core",
      "operator": "CreateTable",
      "parameters": {
        "block_data_check": true,
        "write_disposition": "WRITE_TRUNCATE",
        "destination_table": "td_offer_status_core",
        "destination_dataset": "uk_pre_customer_spine_offer_is",
        "target_type": 2,
        "history": {
          "partition": [{
            "name": "portfolio_offer_id",
            "source_column": "id"
          }],
          "driving_column": [{
              "name": "status_code",
              "source_column": "status"
            },
            {
              "name": "reason_code",
              "source_column": "statusreasoncode"
            }
          ],
          "order": [{
              "name": "effective_from_dt",
              "transformation": "ifnull(uk_tds_chordiant_eod_fc_is.fc_chordiant_bsbportfoliooffer.statuschangeddate,uk_tds_chordiant_eod_fc_is.fc_chordiant_bsbportfoliooffer.effective_from_dt)"
            },
            {
              "name": "effective_from_dt_csn_seq",
              "source_column": "effective_from_dt_csn_seq"
            },
            {
              "name": "effective_from_dt_seq",
              "source_column": "effective_from_dt_seq"
            }
          ]
        },
        "driving_table": "uk_tds_chordiant_eod_fc_is.fc_chordiant_bsbportfoliooffer",
        "joins": [{
          "right": "uk_tds_chordiant_eod_is.cc_chordiant_picklist",
          "on": [{
              "operator": "=",
              "fields": ["uk_tds_chordiant_eod_fc_is.fc_chordiant_bsbportfoliooffer.status", "uk_tds_chordiant_eod_is.cc_chordiant_picklist.code"]
            },
            {
              "operator": "=",
              "fields": ["uk_tds_chordiant_eod_is.cc_chordiant_picklist.logically_deleted", "0"]
            }
          ]
        }],
        "source_to_target": [{
            "name": "portfolio_offer_id",
            "source_name": "uk_tds_chordiant_eod_fc_is.fc_chordiant_bsbportfoliooffer",
            "source_column": "id",
            "pk": true,
            "hk": true
          },
          {
            "name": "dw_last_modified_dt",
            "transformation": "current_timestamp()"
          },
          {
            "name": "effective_from_dt",
            "transformation": "ifnull(uk_tds_chordiant_eod_fc_is.fc_chordiant_bsbportfoliooffer.statuschangeddate,uk_tds_chordiant_eod_fc_is.fc_chordiant_bsbportfoliooffer.effective_from_dt)",
            "pk": true
          },
          {
            "name": "effective_from_dt_csn_seq",
            "source_column": "effective_from_dt_csn_seq",
            "pk": true
          },
          {
            "name": "effective_from_dt_seq",
            "source_column": "effective_from_dt_seq",
            "pk": true
          },
          {
            "name": "effective_to_dt",
            "source_column": "statuschangeddate"
          },
          {
            "name": "status_code",
            "source_column": "status",
            "pk": true
          },
          {
            "name": "status",
            "source_name": "uk_tds_chordiant_eod_is.cc_chordiant_picklist",
            "source_column": "codedesc"
          },
          {
            "name": "reason_code",
            "source_column": "statusreasoncode",
            "pk": true
          },
          {
            "name": "reason",
            "source_name": "uk_tds_chordiant_eod_is.cc_chordiant_picklist",
            "source_column": "codedesc"
          }
        ],
        "where": [{
          "operator": "=",
          "fields": ["uk_tds_chordiant_eod_fc_is.fc_chordiant_bsbportfoliooffer.logically_deleted", "0"]
        }]
      },
      "dependencies": []
    },
    {
      "task_id": "td_offer_priceable_unit_core",
      "operator": "CreateTable",
      "parameters": {
        "block_data_check": true,
        "write_disposition": "WRITE_TRUNCATE",
        "destination_table": "td_offer_priceable_unit_core",
        "destination_dataset": "uk_pre_customer_spine_offer_is",
        "target_type": 1,
        "driving_table": "uk_tds_chordiant_eod_is.cc_chordiant_bsbpriceableunit",
        "source_to_target": [{
            "name": "id",
            "source_column": "id",
            "pk": true
          },
          {
            "name": "dw_last_modified_dt",
            "transformation": "current_timestamp()"
          },
          {
            "name": "created_dt",
            "source_column": "created"
          },
          {
            "name": "created_by_id",
            "source_column": "createdby"
          },
          {
            "name": "last_modified_dt",
            "source_column": "lastupdate"
          },
          {
            "name": "last_modified_by_id",
            "source_column": "updatedby"
          },
          {
            "name": "portfolio_offer_id",
            "source_column": "portfolioofferid"
          },
          {
            "name": "discounted_priceable_unit_id",
            "source_column": "discountedpriceableunitid"
          },
          {
            "name": "effective_dt",
            "source_column": "effectivedate"
          },
          {
            "name": "end_dt",
            "source_column": "endate"
          },
          {
            "name": "quoted_discount",
            "transformation": "abs(uk_tds_chordiant_eod_is.cc_chordiant_bsbpriceableunit.quotedprice)"
          }
        ],
        "where": [{
          "operator": "=",
          "fields": ["uk_tds_chordiant_eod_is.cc_chordiant_bsbpriceableunit.logically_deleted", "0"]
        }]
      },
      "dependencies": []
    },
    {
      "task_id": "td_offer_priceable_unit_soip",
      "operator": "CreateTable",
      "parameters": {
        "block_data_check": true,
        "target_type": 1,
        "sql": "sql/spine_offer_td_offer_priceable_unit_soip.sql",
        "destination_table": "td_offer_priceable_unit_soip",
        "destination_dataset": "uk_pre_customer_spine_offer_is",
        "source_to_target": [{
          "name": "id",
          "pk": true
        }]
      },
      "dependencies": []
    },
    {
      "task_id": "truncate_dim_offer_priceable_unit",
      "operator": "TruncateTable",
      "parameters": {
        "sql": "truncate table uk_pub_customer_spine_offer_is.dim_offer_priceable_unit;",
        "destination_table": "dim_offer_priceable_unit"
      },
      "dependencies": ["td_offer_priceable_unit_soip", "td_offer_priceable_unit_core"]
    },
    {
      "task_id": "dim_offer_priceable_unit_core",
      "operator": "CreateTable",
      "parameters": {
        "block_data_check": true,
        "write_disposition": "WRITE_APPEND",
        "destination_table": "dim_offer_priceable_unit",
        "target_type": 1,
        "driving_table": "uk_pre_customer_spine_offer_is.td_offer_priceable_unit_core",
        "source_to_target": [{
            "name": "id",
            "source_column": "id",
            "pk": true
          },
          {
            "name": "dw_last_modified_dt",
            "source_column": "dw_last_modified_dt"
          },
          {
            "name": "created_dt",
            "source_column": "created_dt"
          },
          {
            "name": "created_by_id",
            "source_column": "created_by_id"
          },
          {
            "name": "last_modified_dt",
            "source_column": "last_modified_dt"
          },
          {
            "name": "last_modified_by_id",
            "source_column": "last_modified_by_id"
          },
          {
            "name": "portfolio_offer_id",
            "source_column": "portfolio_offer_id"
          },
          {
            "name": "discounted_priceable_unit_id",
            "source_column": "discounted_priceable_unit_id"
          },
          {
            "name": "effective_dt",
            "source_column": "effective_dt"
          },
          {
            "name": "end_dt",
            "source_column": "end_dt"
          },
          {
            "name": "quoted_discount",
            "source_column": "quoted_discount"
          }
        ]
      },
      "dependencies": ["truncate_dim_offer_priceable_unit"]
    },
    {
      "task_id": "dim_offer_priceable_unit_soip",
      "operator": "CreateTable",
      "parameters": {
        "block_data_check": true,
        "write_disposition": "WRITE_APPEND",
        "destination_table": "dim_offer_priceable_unit",
        "target_type": 1,
        "driving_table": "uk_pre_customer_spine_offer_is.td_offer_priceable_unit_soip",
        "source_to_target": [{
            "name": "id",
            "source_column": "id",
            "pk": true
          },
          {
            "name": "dw_last_modified_dt",
            "source_column": "dw_last_modified_dt"
          },
          {
            "name": "created_dt",
            "source_column": "created_dt"
          },
          {
            "name": "created_by_id",
            "source_column": "created_by_id"
          },
          {
            "name": "last_modified_dt",
            "source_column": "last_modified_dt"
          },
          {
            "name": "last_modified_by_id",
            "source_column": "last_modified_by_id"
          },
          {
            "name": "portfolio_offer_id",
            "source_column": "portfolio_offer_id"
          },
          {
            "name": "discounted_priceable_unit_id",
            "source_column": "discounted_priceable_unit_id"
          },
          {
            "name": "effective_dt",
            "source_column": "effective_dt"
          },
          {
            "name": "end_dt",
            "source_column": "end_dt"
          },
          {
            "name": "quoted_discount",
            "source_column": "quoted_discount"
          }
        ]
      },
      "dependencies": ["truncate_dim_offer_priceable_unit"]
    },
    {
      "task_id": "dim_offer_priceable_unit_data_check_row_count",
      "operator": "DataCheck",
      "parameters": {
        "sql": "select count(*) from uk_pub_customer_spine_offer_is.dim_offer_priceable_unit"
      },
      "dependencies": ["dim_offer_priceable_unit_soip","dim_offer_priceable_unit_core"]
    },
    {
      "operator": "DataCheck",
      "task_id": "dim_offer_priceable_unit_data_check_duplicate_records",
      "parameters": {
        "sql": "sql/data_check_duplicate_records.sql",
        "params": {
          "DATASET_ID": "uk_pub_customer_spine_offer_is",
          "FROM": "dim_offer_priceable_unit",
          "KEY": ["id"]
        }
      },
      "dependencies": ["dim_offer_priceable_unit_soip","dim_offer_priceable_unit_core"]
    },
    {
      "task_id": "td_offer_discount_core_pt1",
      "operator": "CreateTable",
      "parameters": {
        "block_data_check": true,
        "target_type": 2,
        "sql": "sql/spine_offer_td_offer_discount_1.sql",
        "destination_table": "td_offer_discount_core_pt1",
        "destination_dataset": "uk_pre_customer_spine_offer_is",
        "write_disposition": "WRITE_TRUNCATE",
        "source_to_target": [{
            "name": "portfolio_offer_id",
            "pk": true
          },
          {
            "name": "effective_from_dt",
            "pk": true
          }
        ]
      },
      "dependencies": []
    },
    {
      "task_id": "td_offer_discount_core_pt2",
      "operator": "CreateTable",
      "parameters": {
        "block_data_check": true,
        "target_type": 2,
        "sql": "sql/spine_offer_td_offer_discount_2.sql",
        "destination_table": "td_offer_discount_core_pt2",
        "destination_dataset": "uk_pre_customer_spine_offer_is",
        "write_disposition": "WRITE_TRUNCATE",
        "source_to_target": [{
            "name": "portfolio_offer_id",
            "pk": true
          },
          {
            "name": "effective_from_dt",
            "pk": true
          }
        ]
      },
      "dependencies": ["td_offer_discount_core_pt1"]
    },
    {
      "task_id": "td_offer_discount_soip",
      "operator": "CreateTable",
      "parameters": {
        "block_data_check": true,
        "target_type": 2,
        "sql": "sql/spine_offer_td_offer_discount_soip.sql",
        "destination_table": "td_offer_discount_soip",
        "destination_dataset": "uk_pre_customer_spine_offer_is",
        "write_disposition": "WRITE_TRUNCATE",
        "source_to_target": [{
            "name": "portfolio_offer_id",
            "pk": true
          },
          {
            "name": "effective_from_dt",
            "pk": true
          }
        ]
      },
      "dependencies": []
    },
    {
      "task_id": "dim_offer_discount",
      "operator": "CreateTable",
      "parameters": {
        "target_type": 2,
        "sql": "sql/spine_offer_dim_offer_discount.sql",
        "destination_table": "dim_offer_discount",
        "write_disposition": "WRITE_TRUNCATE",
        "source_to_target": [{
            "name": "portfolio_offer_id",
            "pk": true,
            "hk": true
          },
          {
            "name": "effective_from_dt",
            "pk": true
          }
        ]
      },
      "dependencies": ["td_offer_discount_core_pt2", "td_offer_discount_soip"]
    },
    {
      "task_id": "td_offer_status_soip",
      "operator": "CreateTable",
      "parameters": {
        "block_data_check": true,
        "target_type": 2,
        "sql": "sql/spine_offer_td_offer_status_soip.sql",
        "destination_table": "td_offer_status_soip",
        "destination_dataset": "uk_pre_customer_spine_offer_is",
        "write_disposition": "WRITE_TRUNCATE",
        "source_to_target": [{
            "name": "portfolio_offer_id",
            "pk": true,
            "hk": true
          },
          {
            "name": "effective_from_dt",
            "pk": true
          },
          {
            "name": "effective_from_dt_csn_seq",
            "pk": true
          },
          {
            "name": "effective_from_dt_seq",
            "pk": true
          },
          {
            "name": "status_code",
            "pk": true
          },
          {
            "name": "reason_code",
            "pk": true
          }
        ]
      },
      "dependencies": ["another_dag.task_one"]
    },
    {
      "task_id": "dim_offer_status",
      "operator": "CreateTable",
      "parameters": {
        "target_type": 2,
        "sql": "sql/spine_offer_dim_offer_status.sql",
        "destination_table": "dim_offer_status",
        "write_disposition": "WRITE_TRUNCATE",
        "source_to_target": [{
            "name": "portfolio_offer_id",
            "pk": true,
            "hk": true
          },
          {
            "name": "effective_from_dt",
            "pk": true
          },
          {
            "name": "effective_from_dt_csn_seq",
            "pk": true
          },
          {
            "name": "effective_from_dt_seq",
            "pk": true
          },
          {
            "name": "status_code",
            "pk": true
          },
          {
            "name": "reason_code",
            "pk": true
          }
        ]
      },
      "dependencies": ["td_offer_status_core", "td_offer_status_soip"]
    },
    {
      "operator": "DataCheck",
      "task_id": "dim_offer_status_data_check_new_value_status_code",
      "parameters": {
        "sql": "sql/data_check_new_value.sql",
        "params": {
          "DATASET_ID": "uk_pub_customer_spine_offer_is",
          "FROM": "dim_offer_status",
          "CHECK_FIELD": "status_code",
          "DATE_FIELD": "effective_from_dt"
        }
      },
      "dependencies": ["dim_offer_status"]
    },
    {
      "operator": "DataCheck",
      "task_id": "dim_offer_status_data_check_new_value_reason_code",
      "parameters": {
        "sql": "sql/data_check_new_value.sql",
        "params": {
          "DATASET_ID": "uk_pub_customer_spine_offer_is",
          "FROM": "dim_offer_status",
          "CHECK_FIELD": "reason_code",
          "DATE_FIELD": "effective_from_dt"
        }
      },
      "dependencies": ["dim_offer_status"]
    }
  ]
}